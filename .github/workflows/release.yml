name: 🚀 Build Windows InsuraTask

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (es: 1.0.0)'
        required: true
        default: '1.0.0'

env:
  NODE_VERSION: '18'
  PRODUCT_NAME: 'InsuraTask'

jobs:
  prepare:
    name: 📋 Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract version info
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          TAG="v${VERSION}"
        else
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "🏷️ Building version: ${VERSION} (tag: ${TAG})"

  build-windows:
    name: 🔨 Build Windows
    needs: prepare
    runs-on: windows-latest
    
    steps:
    - name: 📂 Checkout repository
      uses: actions/checkout@v4

    - name: 🟢 Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 🔧 Install dependencies
      run: |
        rm -rf node_modules package-lock.json || true
        npm install
        npm rebuild better-sqlite3
      shell: bash

    - name: 🔍 Type check
      run: npm run check || echo "Type check failed but continuing"

    - name: 🏗️ Build application (Vite + Backend)
      run: npm run build
      env:
        CI: true

    - name: 🖥️ Build Electron app
      run: npm run electron:dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ELECTRON_CACHE: .cache/electron
        ELECTRON_BUILDER_CACHE: .cache/electron-builder
        CSC_IDENTITY_AUTO_DISCOVERY: false

    - name: 🔧 Build CommonJS for standalone
      run: |
        mkdir -p dist-pkg/public
        cp -r dist/public/* dist-pkg/public/ || echo "No static files to copy"
        npx esbuild server/standalone-complete.ts \
          --platform=node \
          --target=node18 \
          --bundle \
          --format=cjs \
          --outdir=dist-pkg \
          --external:wouter \
          --external:wouter/* \
          --external:d3-* \
          --external:react \
          --external:react-dom \
          --external:react/* \
          --external:@radix-ui/* \
          --external:lucide-react \
          --external:@tanstack/* \
          --external:recharts \
          --external:recharts/* \
          --packages=external \
          --minify
      shell: bash
      continue-on-error: true

    - name: ⚡ Build standalone binaries
      run: |
        mkdir -p pkg-dist
        npx pkg dist-pkg/standalone-complete.js --targets=node18-win-x64 --output=pkg-dist/insuratask-win32-standalone.exe
      shell: bash
      continue-on-error: true

    - name: 📋 List generated files
      run: |
        echo "=== Build output summary ==="
        echo "Working directory: $(pwd)"
        
        if [ -d "dist-electron" ]; then
          echo "📦 Electron build output:"
          du -sh dist-electron 2>/dev/null || echo "Could not get size"
          ls -la dist-electron/ 2>/dev/null || echo "Could not list files"
        fi
        
        if [ -d "pkg-dist" ]; then
          echo "⚡ PKG build output:" 
          du -sh pkg-dist 2>/dev/null || echo "Could not get size"
          ls -la pkg-dist/ 2>/dev/null || echo "Could not list files"
        fi
      shell: bash

    - name: 📝 Rename artifacts
      run: |
        if [ -d "dist-electron" ]; then
          cd dist-electron
          for file in *.*; do
            if [[ -f "$file" && "$file" != *.yml && "$file" != *.yaml ]]; then
              extension="${file##*.}"
              new_name="${{ env.PRODUCT_NAME }}-${{ needs.prepare.outputs.version }}-win-x64.${extension}"
              if [[ "$file" != "$new_name" ]]; then
                mv "$file" "$new_name"
                echo "Renamed: $file -> $new_name"
              fi
            fi
          done
          cd ..
        fi
        
        if [ -d "pkg-dist" ]; then
          cd pkg-dist
          for file in *; do
            if [[ -f "$file" ]]; then
              extension=""
              [[ "$file" == *.* ]] && extension=".${file##*.}"
              new_name="${{ env.PRODUCT_NAME }}-${{ needs.prepare.outputs.version }}-win-x64-standalone${extension}"
              if [[ "$file" != "$new_name" ]]; then
                mv "$file" "$new_name"
                echo "Renamed: $file -> $new_name"
              fi
            fi
          done
          cd ..
        fi
      shell: bash
      continue-on-error: true

    - name: 📤 Upload Electron artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-win-x64
        path: dist-electron/*
        retention-days: 30
        if-no-files-found: warn

    - name: 📤 Upload PKG artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pkg-win-x64
        path: pkg-dist/*
        retention-days: 30
        if-no-files-found: ignore

  release:
    name: 🎉 Create GitHub Release
    needs: [prepare, build-windows]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: 📂 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 📥 Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets

    - name: 📁 Organize release files
      run: |
        mkdir -p final-release
        
        find release-assets -type f \( \
          -name "*.exe" -o \
          -name "*.msi" -o \
          -name "*-standalone*" \
        \) -exec cp {} final-release/ \;
        
        echo "=== Files prepared for release ==="
        ls -la final-release/ || echo "No files found"
        
        if [ "$(ls -A final-release/)" ]; then
          echo "=== File sizes ==="
          du -sh final-release/*
        else
          echo "⚠️ No files found for release"
        fi

    - name: 📝 Generate changelog
      id: changelog
      run: |
        echo "## 🚀 InsuraTask v${{ needs.prepare.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### 📦 Download" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "Download the executable for Windows:" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "| Type | File |" >> CHANGELOG.md
        echo "|------|------|" >> CHANGELOG.md
        echo "| 🪟 Portable App | \`InsuraTask-${{ needs.prepare.outputs.version }}-win-x64.exe\` |" >> CHANGELOG.md
        echo "| 🪟 Standalone | \`InsuraTask-${{ needs.prepare.outputs.version }}-win-x64-standalone.exe\` |" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### 🚀 Quick Start" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "1. **Download** the file for Windows" >> CHANGELOG.md
        echo "2. **Run** the executable directly (no installation required)" >> CHANGELOG.md
        echo "3. **Enjoy** managing your insurance tasks!" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### 📋 System Requirements" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **Windows**: Windows 10+ (64-bit)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### 🔧 Known Issues Fixed" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- ✅ Fixed ES Module compatibility issue in standalone builds" >> CHANGELOG.md
        echo "- ✅ Improved build process for better compatibility" >> CHANGELOG.md
        echo "- ✅ Enhanced error handling and debugging" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### 🐛 Issues?" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "Report bugs at: https://github.com/FDRFSR/insuratask/issues" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "*Built with ❤️ by [Federico Fusarri](https://github.com/FDRFSR)*" >> CHANGELOG.md
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: 🎉 Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.tag }}
        name: "🛡️ InsuraTask v${{ needs.prepare.outputs.version }}"
        body: ${{ steps.changelog.outputs.changelog }}
        files: final-release/*
        draft: false
        prerelease: false
        make_latest: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ✅ Release completed
      run: |
        echo "🎉 Release v${{ needs.prepare.outputs.version }} created successfully!"
        echo ""
        echo "📦 Files released:"
        ls -la final-release/ || echo "No files found"
        echo ""
        echo "🔗 Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}"