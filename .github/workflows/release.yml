name: ğŸš€ Build and Release InsuraTask

on:
  push:
    tags:
      - 'v*.*.*'  # Triggerato sui tag versioni (es: v1.0.0)
  workflow_dispatch:  # Permette esecuzione manuale
    inputs:
      version:
        description: 'Version to release (es: 1.0.0)'
        required: true
        default: '1.0.0'

env:
  NODE_VERSION: '18'
  PRODUCT_NAME: 'InsuraTask'

jobs:
  # Job per preparare le informazioni di build
  prepare:
    name: ğŸ“‹ Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract version info
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          TAG="v${VERSION}"
        else
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Building version: ${VERSION} (tag: ${TAG})"

  # Job principale per build multipiattaforma
  build:
    name: ğŸ”¨ Build ${{ matrix.os }}
    needs: prepare
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact_suffix: linux-x64
          - os: windows-latest
            platform: win32
            arch: x64
            artifact_suffix: win-x64
          - os: macos-latest
            platform: darwin
            arch: x64
            artifact_suffix: macos-x64
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # ğŸ”§ Gestisci problemi package-lock.json
    - name: ğŸ”§ Handle package-lock issues
      run: |
        echo "Installing dependencies..."
        
        # Prova npm ci, se fallisce usa npm install
        if ! npm ci --prefer-offline --no-audit; then
          echo "âš ï¸ npm ci failed, falling back to npm install"
          rm -rf node_modules package-lock.json || true
          npm install --no-audit
          echo "âœ… Generated new package-lock.json"
        else
          echo "âœ… npm ci succeeded"
        fi
      shell: bash

    - name: ğŸ” Type check
      run: npm run check

    - name: ğŸ—ï¸ Build application (Electron)
      run: npm run build
      env:
        CI: true

    # ğŸ–¥ï¸ Build Electron (senza icone)
    - name: ğŸ–¥ï¸ Build Electron app
      run: npm run electron:dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ELECTRON_CACHE: .cache/electron
        ELECTRON_BUILDER_CACHE: .cache/electron-builder
        # Disabilita code signing e icone
        CSC_IDENTITY_AUTO_DISCOVERY: false
        DEBUG: electron-builder

    # âš¡ Build pkg (binari standalone) - USA IL NUOVO BUILD
    - name: âš¡ Build standalone binary
      run: |
        echo "Building standalone binary for ${{ matrix.platform }}..."
        
        # ğŸ¯ USA IL NUOVO BUILD SCRIPT per pkg
        if [[ "${{ matrix.platform }}" == "win32" ]]; then
          npm run pkg:win
        elif [[ "${{ matrix.platform }}" == "darwin" ]]; then
          npm run pkg:mac  
        else
          npm run pkg:linux
        fi
        
        echo "âœ… Standalone binary build completed"
      shell: bash
      continue-on-error: true

    # ğŸ“‹ Elenca file generati per debug
    - name: ğŸ“‹ List generated files
      continue-on-error: true
      run: |
        echo "=== Build output summary ==="
        echo "Working directory: $(pwd)"
        
        if [ -d "dist-electron" ]; then
          echo "ğŸ“¦ Electron build output:"
          echo "dist-electron directory exists âœ…"
          du -sh dist-electron 2>/dev/null || echo "Could not get size"
          echo "Files:"
          ls -la dist-electron/ 2>/dev/null || echo "Could not list files"
        else
          echo "âŒ No dist-electron directory found"
        fi
        
        if [ -d "pkg-dist" ]; then
          echo "âš¡ PKG build output:" 
          echo "pkg-dist directory exists âœ…"
          du -sh pkg-dist 2>/dev/null || echo "Could not get size"
          echo "Files:"
          ls -la pkg-dist/ 2>/dev/null || echo "Could not list files"
        else
          echo "âŒ No pkg-dist directory found"
        fi
        
        # ğŸ¯ CONTROLLA ANCHE dist-pkg per debug
        if [ -d "dist-pkg" ]; then
          echo "ğŸ”§ PKG CommonJS build output:"
          echo "dist-pkg directory exists âœ…"
          du -sh dist-pkg 2>/dev/null || echo "Could not get size"
          echo "Files:"
          ls -la dist-pkg/ 2>/dev/null || echo "Could not list files"
        else
          echo "âŒ No dist-pkg directory found"
        fi
      shell: bash

    # ğŸ“ Rinomina file con pattern consistente
    - name: ğŸ“ Rename artifacts
      run: |
        echo "Renaming artifacts for consistency..."
        
        # Rinomina file Electron
        if [ -d "dist-electron" ]; then
          cd dist-electron
          for file in *.*; do
            if [[ -f "$file" && "$file" != *.yml && "$file" != *.yaml ]]; then
              extension="${file##*.}"
              new_name="${{ env.PRODUCT_NAME }}-${{ needs.prepare.outputs.version }}-${{ matrix.artifact_suffix }}.${extension}"
              if [[ "$file" != "$new_name" ]]; then
                mv "$file" "$new_name"
                echo "Renamed: $file -> $new_name"
              fi
            fi
          done
          cd ..
        fi
        
        # Rinomina binari PKG
        if [ -d "pkg-dist" ]; then
          cd pkg-dist
          for file in *; do
            if [[ -f "$file" ]]; then
              extension=""
              [[ "$file" == *.* ]] && extension=".${file##*.}"
              new_name="${{ env.PRODUCT_NAME }}-${{ needs.prepare.outputs.version }}-${{ matrix.artifact_suffix }}-standalone${extension}"
              if [[ "$file" != "$new_name" ]]; then
                mv "$file" "$new_name"
                echo "Renamed: $file -> $new_name"
              fi
            fi
          done
          cd ..
        fi
      shell: bash
      continue-on-error: true

    # ğŸ“¤ Upload Electron artifacts
    - name: ğŸ“¤ Upload Electron artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-${{ matrix.artifact_suffix }}
        path: dist-electron/*
        retention-days: 30
        if-no-files-found: warn

    # ğŸ“¤ Upload PKG artifacts  
    - name: ğŸ“¤ Upload PKG artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pkg-${{ matrix.artifact_suffix }}
        path: pkg-dist/*
        retention-days: 30
        if-no-files-found: ignore

  # Job per creare la release GitHub
  release:
    name: ğŸ‰ Create GitHub Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ğŸ“¥ Download tutti gli artifacts
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets

    # ğŸ“ Organizza i file per la release
    - name: ğŸ“ Organize release files
      run: |
        mkdir -p final-release
        
        echo "=== Organizing release files ==="
        
        # Trova e sposta tutti gli eseguibili
        find release-assets -type f \( \
          -name "*.exe" -o \
          -name "*.msi" -o \
          -name "*.dmg" -o \
          -name "*.pkg" -o \
          -name "*.AppImage" -o \
          -name "*.deb" -o \
          -name "*.rpm" -o \
          -name "*.tar.gz" -o \
          -name "*.zip" -o \
          -name "*-standalone*" \
        \) -exec cp {} final-release/ \;
        
        echo "=== Files prepared for release ==="
        ls -la final-release/ || echo "No files found"
        
        if [ "$(ls -A final-release/)" ]; then
          echo "=== File sizes ==="
          du -sh final-release/*
        else
          echo "âš ï¸ No files found for release"
        fi

    # ğŸ“ Genera changelog
    - name: ğŸ“ Generate changelog
      id: changelog
      run: |
        echo "## ğŸš€ InsuraTask v${{ needs.prepare.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ“¦ Download" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "Download the executable for your platform:" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "| Platform | Type | File |" >> CHANGELOG.md
        echo "|----------|------|------|" >> CHANGELOG.md
        echo "| ğŸªŸ Windows | Portable App | \`InsuraTask-${{ needs.prepare.outputs.version }}-win-x64.exe\` |" >> CHANGELOG.md
        echo "| ğŸªŸ Windows | Standalone | \`InsuraTask-${{ needs.prepare.outputs.version }}-win-x64-standalone.exe\` |" >> CHANGELOG.md
        echo "| ğŸ macOS | DMG Installer | \`InsuraTask-${{ needs.prepare.outputs.version }}-macos-x64.dmg\` |" >> CHANGELOG.md
        echo "| ğŸ macOS | Standalone | \`InsuraTask-${{ needs.prepare.outputs.version }}-macos-x64-standalone\` |" >> CHANGELOG.md
        echo "| ğŸ§ Linux | AppImage | \`InsuraTask-${{ needs.prepare.outputs.version }}-linux-x64.AppImage\` |" >> CHANGELOG.md
        echo "| ğŸ§ Linux | Standalone | \`InsuraTask-${{ needs.prepare.outputs.version }}-linux-x64-standalone\` |" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸš€ Quick Start" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "1. **Download** the file for your operating system" >> CHANGELOG.md
        echo "2. **Run** the executable directly (no installation required for standalone versions)" >> CHANGELOG.md
        echo "3. **Enjoy** managing your insurance tasks!" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ“‹ System Requirements" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **Windows**: Windows 10+ (64-bit)" >> CHANGELOG.md
        echo "- **macOS**: macOS 10.15+ (Catalina)" >> CHANGELOG.md
        echo "- **Linux**: Ubuntu 18.04+ / equivalent" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ”§ Known Issues Fixed" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- âœ… Fixed ES Module compatibility issue in standalone builds" >> CHANGELOG.md
        echo "- âœ… Improved build process for better compatibility" >> CHANGELOG.md
        echo "- âœ… Enhanced error handling and debugging" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ› Issues?" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "Report bugs at: https://github.com/FDRFSR/insuratask/issues" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "*Built with â¤ï¸ by [Federico Fusarri](https://github.com/FDRFSR)*" >> CHANGELOG.md
        
        # Output per GitHub
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # ğŸ‰ Crea la release GitHub
    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.tag }}
        name: "ğŸ›¡ï¸ InsuraTask v${{ needs.prepare.outputs.version }}"
        body: ${{ steps.changelog.outputs.changelog }}
        files: final-release/*
        draft: false
        prerelease: false
        make_latest: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # âœ… Notifica successo
    - name: âœ… Release completed
      run: |
        echo "ğŸ‰ Release v${{ needs.prepare.outputs.version }} created successfully!"
        echo ""
        echo "ğŸ“¦ Files released:"
        ls -la final-release/ || echo "No files found"
        echo ""
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}"